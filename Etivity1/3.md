# Esercizio 3

## Domanda

Progettare degli algoritmi in pseudo codice MapReduce: tale che
Input: a (structured) textual file containing the daily value of PM10 for a set of sensors
Each line of the file has the following format
```
sensorId,date, PM10 value (μg/m3)
```

Output: report for each sensor the number of days with PM10 above a specific threshold
(Suppose to set threshold = 50 μg/m3)

Esempio:

```
Input
s1,2016-01-01,20.5
s1,2016-01-01,30.1
s1,2016-01-02,20.4
s1,2016-01-03,55.5
s2,2016-01-03,52.5

Output
(s1, 1)  // dal 55.5
(s2, 1)  // dal 52.5
```

---

## Svolgimento

```
// FASE MAP
Map(key, value):
    // Input: key = offset nel file (ignorato)
    //        value = linea del file "sensorId,date,PM10_value"
    
    // Parsing della linea
    fields = value.split(",")
    sensorId = fields[0]
    date = fields[1]
    pm10_value = parseFloat(fields[2])
    
    // Controlla se il valore PM10 supera la soglia
    if pm10_value > 50:
        emit(key: sensorId, value: 1)
    // Nota: se PM10 <= 50, non emettiamo nulla

// FASE REDUCE
Reduce(key, values):
    // key = sensorId
    // values = lista di 1 (uno per ogni giorno sopra soglia)
    
    // Conta il numero totale di giorni sopra soglia
    count = 0
    for val in values:
        count = count + val
    
    emit(key: key, value: count)
```

## Versione ottimizzata con Combiner

```
// FASE MAP (identica)
Map(key, value):
    fields = value.split(",")
    sensorId = fields[0]
    date = fields[1]
    pm10_value = parseFloat(fields[2])
    
    if pm10_value > 50:
        emit(key: sensorId, value: 1)

// FASE COMBINER (pre-aggregazione locale)
Combiner(key, values):
    // key = sensorId
    // values = lista di 1 dal mapper locale
    
    local_count = 0
    for val in values:
        local_count = local_count + val
    
    emit(key: key, value: local_count)

// FASE REDUCE
Reduce(key, values):
    // key = sensorId
    // values = lista di conteggi parziali dai combiners
    
    total_count = 0
    for partial_count in values:
        total_count = total_count + partial_count
    
    emit(key: key, value: total_count)
```
